name: Deploy to OKE

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
      OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_KEY_FILE }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup OCI CLI with environment variables
      run: |
        # Install OCI CLI
        bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)" -- --accept-all-defaults
        export PATH="$HOME/bin:$PATH"
        echo "$HOME/bin" >> $GITHUB_PATH
        
        # Create private key file
        mkdir -p ~/.oci
        echo "$OCI_CLI_KEY_CONTENT" > ~/.oci/key.pem
        chmod 600 ~/.oci/key.pem
        
        # Set the key file path for OCI CLI
        export OCI_CLI_KEY_FILE="$HOME/.oci/key.pem"
        echo "OCI_CLI_KEY_FILE=$HOME/.oci/key.pem" >> $GITHUB_ENV
        
        # Test OCI connection (uses environment variables)
        $HOME/bin/oci iam user get --user-id "$OCI_CLI_USER" --query 'data.name'
        
        echo "✅ OCI CLI setup successful"
    
    - name: Configure kubectl for OKE
      run: |
        # Configure kubectl using environment variables
        mkdir -p ~/.kube
        $HOME/bin/oci ce cluster create-kubeconfig \
          --cluster-id ${{ secrets.OKE_CLUSTER_OCID }} \
          --file ~/.kube/config \
          --region "$OCI_CLI_REGION" \
          --token-version 2.0.0
        
        echo "✅ Kubectl configured successfully"
    
    - name: Test kubectl connection
      run: |
        kubectl version --client
        kubectl cluster-info
        kubectl get nodes
        
        echo "✅ Connection to OKE cluster successful"
