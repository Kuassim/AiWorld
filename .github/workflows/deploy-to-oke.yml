name: Deploy to OKE

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Debug secret formats (safe)
      run: |
        echo "User OCID starts with: $(echo '${{ secrets.OCI_USER_OCID }}' | cut -c1-20)..."
        echo "Tenancy OCID starts with: $(echo '${{ secrets.OCI_TENANCY_OCID }}' | cut -c1-20)..."
        echo "Fingerprint format: $(echo '${{ secrets.OCI_FINGERPRINT }}' | wc -c) characters"
        echo "Region: ${{ secrets.OCI_REGION }}"
    
    - name: Setup OCI CLI
      run: |
        bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)" -- --accept-all-defaults
        export PATH="$HOME/bin:$PATH"
        echo "$HOME/bin" >> $GITHUB_PATH
        mkdir -p ~/.oci
        cat > ~/.oci/config << EOL
        [DEFAULT]
        user=${{ secrets.OCI_USER_OCID }}
        fingerprint=${{ secrets.OCI_FINGERPRINT }}
        tenancy=${{ secrets.OCI_TENANCY_OCID }}
        region=${{ secrets.OCI_REGION }}
        key_file=$HOME/.oci/key.pem
        EOL
        echo "${{ secrets.OCI_KEY_FILE }}" > ~/.oci/key.pem
        chmod 600 ~/.oci/key.pem
        chmod 600 ~/.oci/config
    
    - name: Validate OCI config
      run: |
        echo "Config file contents (without sensitive data):"
        sed 's/ocid1\.[^.]*\.oc1\.[^=]*=.*/[REDACTED OCID]/' ~/.oci/config
        $HOME/bin/oci setup repair-file-permissions --file ~/.oci/config
        $HOME/bin/oci setup repair-file-permissions --file ~/.oci/key.pem
