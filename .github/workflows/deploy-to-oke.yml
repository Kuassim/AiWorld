name: Debug OCI Authentication

on:
  push:
    branches: [main]

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Generate fresh key and debug authentication
      run: |
        # Install OCI CLI
        bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)" -- --accept-all-defaults
        export PATH="$HOME/bin:$PATH"
        echo "$HOME/bin" >> $GITHUB_PATH
        
        # Generate fresh key
        mkdir -p ~/.oci
        openssl genrsa -out ~/.oci/key.pem 2048
        openssl rsa -pubout -in ~/.oci/key.pem -out ~/.oci/key_public.pem
        chmod 600 ~/.oci/key.pem
        
        FINGERPRINT=$(openssl rsa -pubout -outform DER -in ~/.oci/key.pem | openssl md5 -c | awk -F'= ' '{print $2}')
        
        # Create config
        cat > ~/.oci/config << EOF
        [DEFAULT]
        user=${{ secrets.OCI_CLI_USER }}
        fingerprint=${FINGERPRINT}
        tenancy=${{ secrets.OCI_CLI_TENANCY }}
        region=${{ secrets.OCI_REGION }}
        key_file=$HOME/.oci/key.pem
        EOF
        chmod 600 ~/.oci/config
        
        echo "=== GENERATED KEY INFO ==="
        echo "Public Key:"
        cat ~/.oci/key_public.pem
        echo ""
        echo "Fingerprint: $FINGERPRINT"
        echo "=========================="
        
        echo "=== TESTING BASIC OCI CONNECTION ==="
        echo "User OCID: ${{ secrets.OCI_CLI_USER }}"
        echo "Region: ${{ secrets.OCI_REGION }}"
        
        # Test basic connection
        echo "Testing user lookup..."
        $HOME/bin/oci iam user get --user-id '${{ secrets.OCI_CLI_USER }}' || echo "❌ User lookup failed"
        
        echo "Testing region list..."
        $HOME/bin/oci iam region list --output table || echo "❌ Region list failed"
        
        echo "Testing tenancy info..."
        $HOME/bin/oci iam tenancy get --tenancy-id '${{ secrets.OCI_CLI_TENANCY }}' || echo "❌ Tenancy lookup failed"
