name: Debug Private Key

on:
  push:
    branches: [main]

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
    - name: Debug private key format
      run: |
        echo "=== Debugging private key format ==="
        
        # Create key file
        mkdir -p ~/.oci
        echo "${{ secrets.OCI_CLI_KEY_CONTENT }}" > ~/.oci/key.pem
        chmod 600 ~/.oci/key.pem
        
        # Check key file size
        echo "Key file size: $(wc -c < ~/.oci/key.pem) bytes"
        
        # Check first and last lines
        echo "First line: $(head -1 ~/.oci/key.pem)"
        echo "Last line: $(tail -1 ~/.oci/key.pem)"
        
        # Check for Windows line endings
        if file ~/.oci/key.pem | grep -q CRLF; then
          echo "❌ Key has Windows line endings"
        else
          echo "✅ Key has Unix line endings"
        fi
        
        # Try to validate the key
        if openssl rsa -check -noout -in ~/.oci/key.pem 2>/dev/null; then
          echo "✅ Private key is valid"
        else
          echo "❌ Private key is invalid"
          echo "OpenSSL error:"
          openssl rsa -check -noout -in ~/.oci/key.pem
        fi
        
        # Show key structure (without revealing content)
        echo "Key structure:"
        grep -E "^-----" ~/.oci/key.pem || echo "No PEM headers found"
