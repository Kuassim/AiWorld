name: Verify kubectl Configuration

on:
  push:
    branches: [main]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup OCI CLI (using your working setup)
      run: |
        # Your existing working OCI CLI setup here
        bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)" -- --accept-all-defaults
        export PATH="$HOME/bin:$PATH"
        echo "$HOME/bin" >> $GITHUB_PATH
        
        mkdir -p ~/.oci
        echo "${{ secrets.OCI_KEY_FILE }}" > ~/.oci/key.pem
        chmod 600 ~/.oci/key.pem
        
        FINGERPRINT=$(openssl rsa -pubout -outform DER -in ~/.oci/key.pem | openssl md5 -c | awk -F'= ' '{print $2}')
        
        cat > ~/.oci/config << EOF
        [DEFAULT]
        user=${{ secrets.OCI_USER_OCID }}
        fingerprint=${FINGERPRINT}
        tenancy=${{ secrets.OCI_TENANCY_OCID }}
        region=${{ secrets.OCI_REGION }}
        key_file=$HOME/.oci/key.pem
        EOF
        
        chmod 600 ~/.oci/config
        
        $HOME/bin/oci iam user get --user-id '${{ secrets.OCI_USER_OCID }}' --query 'data.name'
    
    - name: Configure kubectl for OKE
      run: |
        mkdir -p ~/.kube
        $HOME/bin/oci ce cluster create-kubeconfig \
          --cluster-id ${{ secrets.OKE_CLUSTER_OCID }} \
          --file ~/.kube/config \
          --region '${{ secrets.OCI_REGION }}' \
          --token-version 2.0.0
        
        echo "✅ kubectl configuration completed"
    
    - name: Verify kubectl configuration
      run: |
        echo "=== kubectl Version ==="
        kubectl version --client
        
        echo "=== Cluster Info ==="
        kubectl cluster-info --request-timeout=10s
        
        echo "=== Current Context ==="
        kubectl config current-context
        
        echo "=== Available Contexts ==="
        kubectl config get-contexts
        
        echo "=== Cluster Nodes ==="
        kubectl get nodes
        
        echo "=== Default Namespace Services ==="
        kubectl get services
        
        echo "=== System Namespaces ==="
        kubectl get namespaces
        
        echo "✅ kubectl is fully configured and connected to OKE cluster"
